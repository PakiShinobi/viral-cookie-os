# Contributing

## Development Environment

### Prerequisites

- **Node.js** >= 20.x (LTS)
- **pnpm** >= 9.x (package manager)
- **Docker** (for local PostgreSQL and Redis, or use Neon/Upstash dev instances)
- **Git** >= 2.40

### Initial Setup

```bash
# Clone the repository
git clone git@github.com:PakiShinobi/viral-cookie-os.git
cd viral-cookie-os

# Install dependencies
pnpm install

# Copy environment variables
cp .env.example .env.local

# Start local services (PostgreSQL + Redis)
docker compose up -d

# Run database migrations
pnpm db:migrate

# Seed development data
pnpm db:seed

# Start the development server
pnpm dev
```

The application is available at `http://localhost:3000`. The BullMQ worker runs in-process during development (no separate worker needed).

### Environment Variables

Copy `.env.example` to `.env.local` and fill in the required values. For development, you need at minimum:

- `DATABASE_URL` -- local Docker PostgreSQL or a Neon dev branch connection string.
- `NEXTAUTH_SECRET` -- any random string for local development.
- `ANTHROPIC_API_KEY` -- required for AI generation features. Use a test key with limited budget.

Optional services (Deepgram, YouTube, Shopify) can be left blank; the application gracefully degrades when these are not configured.

### IDE Setup

The repository includes configuration for VS Code:

- `.vscode/settings.json` -- enables format-on-save with Prettier, ESLint auto-fix, and Tailwind CSS IntelliSense.
- `.vscode/extensions.json` -- recommends required extensions (ESLint, Prettier, Tailwind CSS IntelliSense, Prisma/Drizzle).

For other editors, ensure ESLint and Prettier are configured to run on save.

---

## Project Structure

```
viral-cookie-os/
├── docs/                   # Project documentation (you are here)
├── scripts/                # Build, deploy, and utility scripts
├── src/
│   ├── app/                # Next.js App Router (pages, layouts, route handlers)
│   ├── components/         # React components
│   │   ├── ui/             # Base UI primitives (buttons, inputs, dialogs)
│   │   └── features/       # Feature-specific components (content, publishing, AI)
│   ├── db/
│   │   ├── schema/         # Drizzle schema definitions (one file per table group)
│   │   ├── migrations/     # SQL migration files (generated by Drizzle Kit)
│   │   └── index.ts        # Database client export
│   ├── lib/                # Shared utilities, constants, type definitions
│   ├── server/
│   │   ├── routers/        # tRPC router definitions
│   │   ├── services/       # Business logic (content, AI, media, publishing)
│   │   └── trpc.ts         # tRPC initialization and middleware
│   ├── workers/            # BullMQ worker entry points and job handlers
│   └── env.ts              # Environment variable validation (zod)
├── public/                 # Static assets
├── tests/
│   ├── unit/               # Unit tests (co-located or in this directory)
│   ├── integration/        # Integration tests (API, database)
│   └── fixtures/           # Test data and mocks
├── .github/
│   └── workflows/          # GitHub Actions CI/CD
├── drizzle.config.ts       # Drizzle Kit configuration
├── next.config.ts          # Next.js configuration
├── tailwind.config.ts      # Tailwind CSS configuration
├── tsconfig.json           # TypeScript configuration
├── package.json
└── pnpm-lock.yaml
```

---

## Branching Strategy

We use **trunk-based development** with short-lived feature branches.

- `main` -- production. Always deployable. Protected: requires PR with passing CI and at least one approval.
- Feature branches -- created from `main`, named `<type>/<short-description>`:
  - `feat/ai-script-generation`
  - `fix/youtube-upload-timeout`
  - `chore/update-dependencies`
  - `docs/add-api-reference`

Branch lifetime should not exceed 3 days. If a feature is larger, break it into incremental PRs that can be merged independently behind a feature flag.

---

## Commit Conventions

We follow [Conventional Commits](https://www.conventionalcommits.org/):

```
<type>(<scope>): <short description>

<optional body>

<optional footer>
```

### Types

| Type | Use for |
|---|---|
| `feat` | New functionality visible to users |
| `fix` | Bug fixes |
| `refactor` | Code changes that neither fix a bug nor add a feature |
| `chore` | Tooling, config, dependencies, CI |
| `docs` | Documentation changes |
| `test` | Adding or modifying tests |
| `perf` | Performance improvements |

### Scope

Use the system component: `content`, `ai`, `media`, `publish`, `auth`, `ui`, `db`, `worker`, `infra`.

### Examples

```
feat(ai): add streaming script generation with Claude
fix(publish): handle YouTube quota exceeded error with retry
refactor(content): extract pipeline state machine into standalone module
chore(deps): update Next.js to 14.2.0
test(media): add integration tests for R2 upload flow
```

---

## Pull Request Process

### Opening a PR

1. Push your branch and open a PR against `main`.
2. Fill in the PR template:
   - **Summary**: what changed and why (1-3 sentences).
   - **Changes**: bulleted list of specific changes.
   - **Testing**: how you verified the changes work.
   - **Screenshots**: if the change has UI impact, attach before/after screenshots.
3. Assign at least one reviewer.
4. Ensure CI passes (lint, type-check, tests).

### Review Standards

Reviewers should verify:

- **Correctness**: does the code do what the PR claims?
- **Types**: are TypeScript types accurate and specific (avoid `any`)?
- **Tests**: are new code paths covered by tests?
- **Security**: no API keys, secrets, or user data logged; inputs validated at system boundaries.
- **Performance**: no N+1 queries, unnecessary re-renders, or unbounded data fetches.
- **Naming**: variables, functions, and files follow existing conventions.

### Merging

- Use **Squash and Merge** for feature branches (single clean commit on `main`).
- The squash commit message should follow the conventional commit format.
- Delete the feature branch after merge.

---

## Code Standards

### TypeScript

- Strict mode is enabled (`strict: true` in `tsconfig.json`).
- Avoid `any` -- use `unknown` and narrow with type guards.
- Prefer `interface` for object shapes, `type` for unions and intersections.
- Export types alongside their implementations, not from barrel files.

### React

- Use functional components exclusively.
- Server Components by default; add `"use client"` only when the component uses browser APIs, hooks, or event handlers.
- Co-locate component-specific types, utilities, and styles with the component file.
- Name components with PascalCase; name files with kebab-case matching the component (`ContentCard` → `content-card.tsx`).

### Database

- Schema changes are always made through Drizzle schema files, never through raw SQL in application code.
- Every query must filter by `workspace_id` (enforced by middleware; verified in review).
- Use transactions for multi-table writes.
- Avoid `SELECT *` -- explicitly list columns.

### Error Handling

- API errors return structured responses: `{ error: { code: string, message: string } }`.
- Use tRPC error codes appropriately: `NOT_FOUND`, `UNAUTHORIZED`, `FORBIDDEN`, `BAD_REQUEST`, `INTERNAL_SERVER_ERROR`.
- Log errors with context (user ID, workspace ID, operation) but never log sensitive data (tokens, passwords, PII).

### Testing

- **Unit tests**: pure functions, utilities, state machines. Run fast, no external dependencies.
- **Integration tests**: tRPC routers against a test database. Use transactions that roll back after each test.
- **Naming**: `describe("functionName")` > `it("returns X when given Y")`.
- **Test runner**: Vitest.
- Run tests: `pnpm test` (all), `pnpm test:unit`, `pnpm test:integration`.

---

## Scripts Reference

| Command | Description |
|---|---|
| `pnpm dev` | Start development server with hot reload |
| `pnpm build` | Production build |
| `pnpm start` | Start production server |
| `pnpm lint` | Run ESLint |
| `pnpm type-check` | Run TypeScript compiler (no emit) |
| `pnpm test` | Run all tests |
| `pnpm test:unit` | Run unit tests only |
| `pnpm test:integration` | Run integration tests only |
| `pnpm db:generate` | Generate migration from schema changes |
| `pnpm db:migrate` | Apply pending migrations |
| `pnpm db:seed` | Seed development data |
| `pnpm db:studio` | Open Drizzle Studio (database browser) |
| `pnpm worker:start` | Start BullMQ workers (production) |

---

## Reporting Issues

- Use GitHub Issues for bug reports, feature requests, and questions.
- For bugs, include: steps to reproduce, expected behavior, actual behavior, browser/OS, and relevant logs.
- For feature requests, describe the use case and desired outcome rather than a specific implementation.

## Security

If you discover a security vulnerability, do **not** open a public issue. Instead, email `security@viralcookieos.com` with details. We will acknowledge within 24 hours and provide a timeline for resolution.
